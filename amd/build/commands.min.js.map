{"version":3,"file":"commands.min.js","sources":["../src/commands.js"],"sourcesContent":["import {icon, component} from './common';\nimport {getButtonImage} from 'editor_tiny/utils';\nimport {get_string as getString} from 'core/str';\n\nimport {getCourseId, getUbicastURL, useFilter} from \"./options\";\n\n/**\n * Add a correction on the current selection.\n * @param {tinyMCE} editor\n * @returns {void}\n */\nasync function insertMedia(editor) {\n    const courseid = getCourseId(editor);\n    const usefilter = useFilter(editor) === '1';\n    const ubicastURL = getUbicastURL(editor);\n    const [\n        panelTitle,\n    ] = await Promise.all([\n        getString('pluginname', component),\n    ]);\n\n    const xhttp = new XMLHttpRequest();\n    xhttp.onreadystatechange = function () {\n        if (this.readyState === 4 && this.status === 200) {\n            //Create iframe content\n            const form_id = 'id_resource_tiny_ubicast_' + new Date().getTime();\n            const content = document.createElement('div');\n            content.innerHTML = this.responseText;\n            content.querySelector('form').id = form_id;\n\n            editor.windowManager.open({\n                title: panelTitle,\n                body: {\n                    type: 'panel',\n                    items: [\n                        {\n                            type: 'htmlpanel',\n                            html: '<div id=\"ubicast_content\"></div>'\n                        },\n                    ]\n                },\n                buttons: [\n                    {\n                        type: 'cancel',\n                        text: 'Close'\n                    },\n                    {\n                        type: 'submit',\n                        text: 'Save',\n                        buttonType: 'primary'\n                    }\n                ],\n                onSubmit: (api) => {\n                    const video_link = create_video_link(courseid, usefilter, ubicastURL);\n                    editor.insertContent(video_link);\n                    api.close();\n                }\n            });\n            document.getElementById('ubicast_content').appendChild(content);\n            setTimeout(function () {\n                // Use setTimeout to wait for MediaSelector loading.\n                window.mediaSelector = new window.MediaSelector({\n                    moodleURL: window.M.cfg.wwwroot + '/mod/ubicast/lti.php?id=' + courseid,\n                    nudgisURL: ubicastURL,\n                    filterBySpeaker: true,\n                    target: form_id\n                });\n            }, (window.MediaSelector ? 10 : 2000));\n        }\n    };\n    xhttp.open('GET', window.M.cfg.wwwroot + '/lib/editor/tiny/plugins/ubicast/media.php', true);\n    xhttp.send();\n}\n\n\nexport const getSetup = async () => {\n    const [\n        insertButtonName,\n        buttonImage,\n    ] = await Promise.all([\n        getString('inputsubmit', component),\n        getButtonImage('icon', component),\n    ]);\n\n    return (editor) => {\n        editor.ui.registry.addIcon(icon, buttonImage.html);\n\n        // Register the insert media Toolbar Button.\n        editor.ui.registry.addButton('insert_media', {\n            icon: icon,\n            tooltip: insertButtonName,\n            onAction: () => insertMedia(editor)\n        });\n    };\n};\n\n/**\n * Function to retrieve the course id from the current page.\n *\n * @method create_video_link\n * @param {number} course_id The course id.\n * @param {boolean} use_filter The use filter option.\n * @param {string} ubicast_url The ubicast url.\n * @return {string} The cource id.\n * @private\n */\nexport function create_video_link(course_id, use_filter, ubicast_url) {\n\n    const media_id = document.getElementById('id_mediaid').value;\n    const media_width = document.getElementById('id_mediawidth').value;\n    const media_height = document.getElementById('id_mediaheight').value;\n    const media_thumb = document.getElementById('id_mediaimg').value || '/static/mediaserver/images/video.svg';\n\n    let video_url = '';\n    if (media_id) {\n        if (use_filter) {\n            const thumb_url = ubicast_url + media_thumb;\n            video_url = '<img class=\"atto_ubicast courseid_' + course_id + '_mediaid_'\n                + media_id + '\" style=\"display: block; width: '\n                + media_width + '; height: ' + media_height + ';\"' + ' src=\"' + thumb_url + '\" alt=\"\"/>';\n        } else {\n            const url = '/lib/editor/tiny/plugins/ubicast/view.php?course=' + course_id + ' &video= + ' + media_id;\n            video_url = '<iframe class=\"nudgis-iframe\" ' +\n                'style=\"width:' + media_width + '; height: ' + media_height + '; background-color: #ddd;\" ' +\n                'src=\"' + window.M.cfg.wwwroot + url + '\" ' +\n                ' allow=\"autoplay; encrypted-media\" allowfullscreen=\"allowfullscreen\">' +\n                '</iframe>';\n        }\n    }\n\n    return video_url;\n}\n"],"names":["create_video_link","course_id","use_filter","ubicast_url","media_id","document","getElementById","value","media_width","media_height","media_thumb","video_url","url","window","M","cfg","wwwroot","async","insertButtonName","buttonImage","Promise","all","component","editor","ui","registry","addIcon","icon","html","addButton","tooltip","onAction","courseid","usefilter","ubicastURL","panelTitle","xhttp","XMLHttpRequest","onreadystatechange","this","readyState","status","form_id","Date","getTime","content","createElement","innerHTML","responseText","querySelector","id","windowManager","open","title","body","type","items","buttons","text","buttonType","onSubmit","api","video_link","insertContent","close","appendChild","setTimeout","mediaSelector","MediaSelector","moodleURL","nudgisURL","filterBySpeaker","target","send","insertMedia"],"mappings":"yRA0GgBA,kBAAkBC,UAAWC,WAAYC,mBAE/CC,SAAWC,SAASC,eAAe,cAAcC,MACjDC,YAAcH,SAASC,eAAe,iBAAiBC,MACvDE,aAAeJ,SAASC,eAAe,kBAAkBC,MACzDG,YAAcL,SAASC,eAAe,eAAeC,OAAS,2CAEhEI,UAAY,MACZP,YACIF,WAAY,CAEZS,UAAY,qCAAuCV,UAAY,YACzDG,SAAW,mCACXI,YAAc,aAAeC,aAFvB,YADMN,YAAcO,aAGgD,iBAC7E,OACGE,IAAM,oDAAsDX,UAAY,cAAgBG,SAC9FO,UAAY,8CACUH,YAAc,aAAeC,aADvC,mCAEEI,OAAOC,EAAEC,IAAIC,QAAUJ,IAFzB,0FAQbD,4BAvDaM,gBAEhBC,iBACAC,mBACMC,QAAQC,IAAI,EAClB,mBAAU,cAAeC,oBACzB,yBAAe,OAAQA,4BAGnBC,SACJA,OAAOC,GAAGC,SAASC,QAAQC,aAAMR,YAAYS,MAG7CL,OAAOC,GAAGC,SAASI,UAAU,eAAgB,CACzCF,KAAMA,aACNG,QAASZ,iBACTa,SAAU,mBAhFKR,cACjBS,UAAW,wBAAYT,QACvBU,UAAkC,OAAtB,sBAAUV,QACtBW,YAAa,0BAAcX,SAE7BY,kBACMf,QAAQC,IAAI,EAClB,mBAAU,aAAcC,qBAGtBc,MAAQ,IAAIC,eAClBD,MAAME,mBAAqB,cACC,IAApBC,KAAKC,YAAoC,MAAhBD,KAAKE,OAAgB,OAExCC,QAAU,6BAA8B,IAAIC,MAAOC,UACnDC,QAAUxC,SAASyC,cAAc,OACvCD,QAAQE,UAAYR,KAAKS,aACzBH,QAAQI,cAAc,QAAQC,GAAKR,QAEnCnB,OAAO4B,cAAcC,KAAK,CACtBC,MAAOlB,WACPmB,KAAM,CACFC,KAAM,QACNC,MAAO,CACH,CACID,KAAM,YACN3B,KAAM,sCAIlB6B,QAAS,CACL,CACIF,KAAM,SACNG,KAAM,SAEV,CACIH,KAAM,SACNG,KAAM,OACNC,WAAY,YAGpBC,SAAWC,YACDC,WAAa9D,kBAAkBgC,SAAUC,UAAWC,YAC1DX,OAAOwC,cAAcD,YACrBD,IAAIG,WAGZ3D,SAASC,eAAe,mBAAmB2D,YAAYpB,SACvDqB,YAAW,WAEPrD,OAAOsD,cAAgB,IAAItD,OAAOuD,cAAc,CAC5CC,UAAWxD,OAAOC,EAAEC,IAAIC,QAAU,2BAA6BgB,SAC/DsC,UAAWpC,WACXqC,iBAAiB,EACjBC,OAAQ9B,YAEZ7B,OAAOuD,cAAgB,GAAK,OAGxChC,MAAMgB,KAAK,MAAOvC,OAAOC,EAAEC,IAAIC,QAAU,8CAA8C,GACvFoB,MAAMqC,OAoBkBC,CAAYnD"}